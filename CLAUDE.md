# Claude Code 開発ガイドライン

## 絶対的なルール

### 時間・日付処理について
このシステムでは**日本時間（JST/UTC+9）を絶対的な基準**とする。

#### 必須事項
1. **全ての日時処理は日本時間で統一する**
2. **データベース保存時も日本時間で保存する**
3. **フロントエンドとバックエンド間のやり取りも日本時間で行う**
4. **UTCへの変換は絶対に行わない**

#### 禁止事項
- `toISOString()`の使用（UTCに変換されるため）
- `new Date().getTime()`をそのまま使用
- タイムゾーン変換処理
- UTC基準での日付計算
- ハードコーディング（ロール名、権限名等）

#### 使用すべきユーティリティ
- `/src/lib/dateUtils.ts`の関数を必ず使用する
- 生のDateオブジェクト操作は避ける

## 権限管理システム

### ロール管理の統一ルール
このシステムでは**CustomRoleテーブルによる統一的な権限管理**を採用している。

#### 必須事項
1. **全ての権限チェックはCustomRoleテーブルを基準とする**
2. **ハードコードされたロール名（SUPER_ADMIN等）の使用を避ける**
3. **新機能追加時は適切な権限チェックを実装する**
4. **権限チェックは`hasPermission()`関数を使用する**

#### 権限カテゴリ
- `userManagement`: ユーザー管理（作成・編集・削除・閲覧）
- `shiftManagement`: シフト管理（承認・編集・削除・閲覧・強制登録・ロック操作）
- `attendanceManagement`: 勤怠管理（全閲覧・強制打刻・他者編集）
- `expenseManagement`: 経費管理（承認・全閲覧・ロック操作）
- `systemSettings`: システム設定（会社管理・ロール管理・パートナー管理）

#### 実装パターン
```typescript
// 権限チェック例
const hasEditPermission = await hasPermission(currentUser.id, "userManagement", "edit");
if (!hasEditPermission) {
  return NextResponse.json({ error: "権限がありません" }, { status: 403 });
}
```

## セキュリティガイドライン

### 認証・認可
1. **全てのAPIエンドポイントで認証チェック必須**
   - `getCurrentUser(request)`でユーザー認証を確認
   - 認証失敗時は401エラーを返す

2. **適切な権限チェックの実装**
   - 機能に応じた細かい権限チェック
   - 自分のデータのみアクセス可能な制御
   - 管理者権限の適切な分離

3. **JWT トークン管理**
   - `JWT_SECRET_STRING`を使用
   - トークンの適切な検証と期限管理

### データセキュリティ
1. **パスワード管理**
   - bcryptによるハッシュ化必須
   - 平文パスワードの保存・ログ出力禁止

2. **機密情報の保護**
   - 環境変数での機密情報管理
   - APIレスポンスでの機密情報除外
   - ログでの機密情報出力禁止

3. **入力値検証**
   - 全ての入力値のバリデーション
   - SQLインジェクション対策（Prisma使用）
   - XSS対策（適切なエスケープ）

### API設計
1. **RESTful設計原則**
   - 適切なHTTPメソッド使用
   - 統一されたエラーレスポンス
   - 適切なステータスコード

2. **エラーハンドリング**
   - try-catch文での例外処理
   - ユーザーフレンドリーなエラーメッセージ
   - 詳細なエラーログ出力

## データベース設計

### Prisma使用規則
1. **型安全性の確保**
   - Prisma Clientの型を活用
   - includeとselectの適切な使用
   - リレーションの適切な定義

2. **クエリ最適化**
   - 必要なフィールドのみ取得
   - N+1問題の回避
   - 適切なインデックス設定

3. **トランザクション管理**
   - 複数テーブル更新時はトランザクション使用
   - 適切なロールバック処理

## フロントエンド開発

### React/Next.js ベストプラクティス
1. **コンポーネント設計**
   - 単一責任の原則
   - 再利用可能なコンポーネント
   - 適切なpropsの型定義

2. **状態管理**
   - useStateとuseEffectの適切な使用
   - 不要な再レンダリングの回避
   - カスタムフックの活用

3. **パフォーマンス**
   - lazy loadingの活用
   - 適切なmemoization
   - 画像最適化

### UI/UX
1. **アクセシビリティ**
   - 適切なaria属性
   - キーボードナビゲーション
   - スクリーンリーダー対応

2. **レスポンシブデザイン**
   - モバイルファーストアプローチ
   - Tailwind CSSの活用
   - ブレークポイントの統一

## 開発フロー

### コマンド
- **テスト実行**: `npm test`
- **リント実行**: `npm run lint`
- **型チェック**: `npm run typecheck`
- **ビルド**: `npm run build`
- **開発サーバー**: `npm run dev`
- **Prisma生成**: `npx prisma generate`
- **マイグレーション**: `npx prisma migrate dev`

### 技術スタック
- **フレームワーク**: Next.js 15
- **言語**: TypeScript
- **データベース**: MySQL + Prisma ORM
- **認証**: カスタムJWT認証
- **スタイリング**: Tailwind CSS
- **状態管理**: React Hooks

### 開発時の注意事項
1. **コード品質**
   - TypeScript厳密モードの維持
   - ESLintルールの遵守
   - コードレビューの実施

2. **テスト**
   - 単体テストの作成
   - 統合テストの実施
   - E2Eテストの検討

3. **パフォーマンス**
   - バンドルサイズの監視
   - Core Web Vitalsの最適化
   - データベースクエリの最適化

4. **メンテナンス性**
   - 明確なコメント記述
   - 適切な関数・変数命名
   - モジュール分割の実施

## 緊急時対応

### デバッグ
1. **ログ確認**
   - サーバーログの確認
   - ブラウザコンソールの確認
   - Prismaクエリログの確認

2. **エラートラッキング**
   - エラーの再現手順記録
   - スタックトレースの保存
   - 影響範囲の特定

### バックアップ・復旧
1. **データベースバックアップ**
   - 定期的なバックアップ実行
   - 復旧手順の文書化
   - テストデータでの復旧確認